using NBitcoin;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;
using WalletWasabi.WabiSabi.Backend.Banning;
using WalletWasabi.WabiSabi.Backend.Banning.CVP2;
using Xunit;

namespace WalletWasabi.Tests.UnitTests.WabiSabi.Backend;

public class CoinVerifierProvider2Tests
{
	public Coin CreatCoin(string address)
	{
		if (address.Length == 0)
		{
			return new Coin();
		}
		Coin coin = new Coin(new OutPoint(uint256.Zero, 0), new TxOut(Money.Coins(1.0m), BitcoinAddress.Create(address, Network.Main).ScriptPubKey));
		return coin;
	}

	[Fact]
	public async Task ParseResultTestsAsync()
	{
		CoinVerifierRiskConfig riskConfig = new(null, null);
		using HttpResponseMessage message = new();

		message.StatusCode = System.Net.HttpStatusCode.NotFound;
		message.Content = new StringContent("""{ "id":"12", "name":"NotInBlockchain", "message":"Not yet processed.", "status":404 }""");
		var result = await CVP2ApiResponse.ParseResponseAsync(message);
		result.Evaluate(0, riskConfig);
		var detail = result.GetDetails();
		Assert.Equal("12|_RP|httpError(NotFound)|   NaN(   NaN, 0.000, 0.000, 0.000)|||||HttpError NotInBlockchain:Not yet processed.", detail);

		message.StatusCode = System.Net.HttpStatusCode.OK;
		message.Content = new StringContent("""{"analysed_by":{"id":"10","type":"api_key"},"cluster_entities":[{"name":"Unknown","category":"Unknown","actor_id":0,"is_primary_entity":true,"is_vasp":null,"is_after_sanction_date":false}],"id":"11","screening_id":"12","subject":{"asset":"holistic","hash":"bc1234","type":"address","blockchain":"holistic"},"type":"wallet_exposure","customer":{"id":null,"reference":""},"created_at":"2024-05-29T00:00:00.000Z","updated_at":"2024-05-29T00:00:00.000Z","analysed_at":"2024-05-29T00:00:00.000Z","process_status":"complete","process_status_id":2,"workflow_status_id":1,"workflow_status":"active","error":null,"team_id":"13","asset_tier":"full","risk_score":10,"blockchain_info":{"cluster":{"inflow_value":{"usd":941.572289},"outflow_value":{"usd":915.247003}}},"risk_score_detail":{"destination":10,"source":10},"evaluation_detail":{"source":[{"rule_id":"14","rule_type":"exposure","risk_score":10,"matched_behaviors":[],"matched_elements":[{"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"contributions":[{"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"is_screened_address":false,"contribution_value":{"usd":941.572289},"indirect_percentage":0,"min_number_of_hops":1,"indirect_value":{"usd":0},"risk_triggers":{"category_id":"15","category":"Market"},"contribution_percentage":100,"entity":"Market1"}],"contribution_value":{"usd":941.572289},"indirect_percentage":0,"indirect_value":{"usd":0},"category":"Market","contribution_percentage":100}],"rule_name":"Illicit"}],"destination":[{"rule_id":"16","rule_type":"exposure","risk_score":10,"matched_behaviors":[],"matched_elements":[{"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"contributions":[{"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"is_screened_address":false,"contribution_value":{"usd":915.247003},"indirect_percentage":0,"min_number_of_hops":1,"indirect_value":{"usd":0},"risk_triggers":{"category_id":"17","category":"Wallet"},"contribution_percentage":100,"entity":"Wallet1"}],"contribution_value":{"usd":915.247003},"indirect_percentage":0,"indirect_value":{"usd":0},"category":"Wallet","contribution_percentage":100}],"rule_name":"Obfuscating"}]},"contributions":{"source":[{"contribution_percentage":100,"contribution_value":{"usd":941.572289},"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"entities":[{"name":"Market1","category":"Market","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}],"destination":[{"contribution_percentage":100,"contribution_value":{"usd":915.247003},"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"entities":[{"name":"Wallet1","category":"Wallet","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}]},"triggered_rules":[],"changes":{},"screening_source":"sync","detected_behaviors":[]}""");
		result = await CVP2ApiResponse.ParseResponseAsync(message);
		result.Evaluate(0, riskConfig);
		detail = result.GetDetails();
		Assert.Equal("11|BR_|complete|10.000(10.000, 0.000,10.000,10.000)|Illicit(10.000)|Market|Obfuscating(10.000)|Wallet|", detail);

		message.Content = new StringContent("""{"analysed_by":{"id":"10","type":"api_key"},"cluster_entities":[{"name":"Unknown","category":"Unknown","actor_id":0,"is_primary_entity":true,"is_vasp":null,"is_after_sanction_date":false}],"id":"11","screening_id":"12","subject":{"asset":"holistic","hash":"bc123456","type":"address","blockchain":"holistic"},"type":"wallet_exposure","customer":{"id":null,"reference":""},"created_at":"2024-05-29T00:00:00.000Z","updated_at":"2024-05-29T00:00:00.000Z","analysed_at":"2024-05-29T00:00:00.000Z","process_status":"complete","process_status_id":2,"workflow_status_id":1,"workflow_status":"active","error":null,"team_id":"13","asset_tier":"full","risk_score":null,"blockchain_info":{"cluster":{"inflow_value":{"usd":4.99},"outflow_value":{"usd":6.4699963988953995}}},"risk_score_detail":{"destination":null,"source":null},"evaluation_detail":{"source":[],"destination":[]},"contributions":{"source":[{"contribution_percentage":100,"contribution_value":{"usd":4.99},"counterparty_percentage":100,"counterparty_value":{"usd":4.99},"entities":[{"name":"Exch1","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}],"destination":[{"contribution_percentage":97.1497,"contribution_value":{"usd":6.28558559},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Unknown","category":"Unknown","actor_id":0,"is_primary_entity":true,"is_vasp":null}],"is_screened_address":true,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":0},{"contribution_percentage":1.7273601037592121,"contribution_value":{"usd":0.11176019871322102},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch2","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":1.7273601037592121,"indirect_value":{"usd":0.11176019871322102},"min_number_of_hops":3},{"contribution_percentage":0.8381907573348266,"contribution_value":{"usd":0.054230941999563284},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Brg","category":"Bridge","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0.8381907573348266,"indirect_value":{"usd":0.054230941999563284},"min_number_of_hops":4},{"contribution_percentage":0.1428931397504208,"contribution_value":{"usd":0.009245186141852225},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch3","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.1428931397504208,"indirect_value":{"usd":0.009245186141852225},"min_number_of_hops":4},{"contribution_percentage":0.06395808977448295,"contribution_value":{"usd":0.004138088408409046},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch4","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.06395808977448295,"indirect_value":{"usd":0.004138088408409046},"min_number_of_hops":4},{"contribution_percentage":0.05274613176210563,"contribution_value":{"usd":0.0034126747250082345},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch5","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.05274613176210563,"indirect_value":{"usd":0.0034126747250082345},"min_number_of_hops":4},{"contribution_percentage":0.01476863233473315,"contribution_value":{"usd":0.0009555305120572348},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch6","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.01476863233473315,"indirect_value":{"usd":0.0009555305120572348},"min_number_of_hops":6},{"contribution_percentage":0.010327486789610252,"contribution_value":{"usd":0.0006681883952877833},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch7","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.010327486789610252,"indirect_value":{"usd":0.0006681883952877833},"min_number_of_hops":5}]},"triggered_rules":[],"changes":{"risk_score_change":0},"screening_source":"sync","detected_behaviors":[]}""");
		result = await CVP2ApiResponse.ParseResponseAsync(message);
		result.Evaluate(0, riskConfig);
		detail = result.GetDetails();
		Assert.Equal("11|___|complete| 0.000(   NaN, 0.000, 0.000, 0.000)||Exchange||Bridge/Exchange/Unknown|", detail);

		message.Content = new StringContent("""{"analysed_by":{"id":"10","type":"api_key"},"cluster_entities":[{"name":"Unknown","category":"Unknown","actor_id":0,"is_primary_entity":true,"is_vasp":null,"is_after_sanction_date":false}],"id":"11","screening_id":"12","subject":{"asset":"holistic","hash":"bc1234","type":"address","blockchain":"holistic"},"type":"wallet_exposure","customer":{"id":null,"reference":""},"created_at":"crash","updated_at":"2024-05-29T00:00:00.000Z","analysed_at":"2024-05-29T00:00:00.000Z","process_status":"complete","process_status_id":2,"workflow_status_id":1,"workflow_status":"active","error":null,"team_id":"13","asset_tier":"full","risk_score":10,"blockchain_info":{"cluster":{"inflow_value":{"usd":941.572289},"outflow_value":{"usd":915.247003}}},"risk_score_detail":{"destination":10,"source":10},"evaluation_detail":{"source":[{"rule_id":"14","rule_type":"exposure","risk_score":10,"matched_behaviors":[],"matched_elements":[{"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"contributions":[{"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"is_screened_address":false,"contribution_value":{"usd":941.572289},"indirect_percentage":0,"min_number_of_hops":1,"indirect_value":{"usd":0},"risk_triggers":{"category_id":"15","category":"Market"},"contribution_percentage":100,"entity":"Market1"}],"contribution_value":{"usd":941.572289},"indirect_percentage":0,"indirect_value":{"usd":0},"category":"Market","contribution_percentage":100}],"rule_name":"Illicit"}],"destination":[{"rule_id":"16","rule_type":"exposure","risk_score":10,"matched_behaviors":[],"matched_elements":[{"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"contributions":[{"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"is_screened_address":false,"contribution_value":{"usd":915.247003},"indirect_percentage":0,"min_number_of_hops":1,"indirect_value":{"usd":0},"risk_triggers":{"category_id":"17","category":"Wallet"},"contribution_percentage":100,"entity":"Wallet1"}],"contribution_value":{"usd":915.247003},"indirect_percentage":0,"indirect_value":{"usd":0},"category":"Wallet","contribution_percentage":100}],"rule_name":"Obfuscating"}]},"contributions":{"source":[{"contribution_percentage":100,"contribution_value":{"usd":941.572289},"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"entities":[{"name":"Market1","category":"Market","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}],"destination":[{"contribution_percentage":100,"contribution_value":{"usd":915.247003},"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"entities":[{"name":"Wallet1","category":"Wallet","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}]},"triggered_rules":[],"changes":{},"screening_source":"sync","detected_behaviors":[]}""");
		result = await CVP2ApiResponse.ParseResponseAsync(message);
		result.Evaluate(0, riskConfig);
		detail = result.GetDetails();
		Assert.Equal("11|BRP|complete|10.000(10.000, 0.000, 0.000, 0.000)|||||ParseError Exception:Could not convert string to DateTime: crash. Path 'created_at', line 1, position 390.", detail);

		message.Content = new StringContent("""{"analysed_by":{"id":"10","type":"api_key"},"cluster_entities":[{"name":"Unknown","category":"Unknown","actor_id":0,"is_primary_entity":true,"is_vasp":null,"is_after_sanction_date":false}],"id":"11","screening_id":"12","subject":{"asset":"holistic","hash":"bc123456","type":"address","blockchain":"holistic"},"type":"wallet_exposure","customer":{"id":null,"reference":""},"created_at":"crash","updated_at":"2024-05-29T00:00:00.000Z","analysed_at":"2024-05-29T00:00:00.000Z","process_status":"complete","process_status_id":2,"workflow_status_id":1,"workflow_status":"active","error":null,"team_id":"13","asset_tier":"full","risk_score":null,"blockchain_info":{"cluster":{"inflow_value":{"usd":4.99},"outflow_value":{"usd":6.4699963988953995}}},"risk_score_detail":{"destination":null,"source":null},"evaluation_detail":{"source":[],"destination":[]},"contributions":{"source":[{"contribution_percentage":100,"contribution_value":{"usd":4.99},"counterparty_percentage":100,"counterparty_value":{"usd":4.99},"entities":[{"name":"Exch1","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}],"destination":[{"contribution_percentage":97.1497,"contribution_value":{"usd":6.28558559},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Unknown","category":"Unknown","actor_id":0,"is_primary_entity":true,"is_vasp":null}],"is_screened_address":true,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":0},{"contribution_percentage":1.7273601037592121,"contribution_value":{"usd":0.11176019871322102},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch2","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":1.7273601037592121,"indirect_value":{"usd":0.11176019871322102},"min_number_of_hops":3},{"contribution_percentage":0.8381907573348266,"contribution_value":{"usd":0.054230941999563284},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Brg","category":"Bridge","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0.8381907573348266,"indirect_value":{"usd":0.054230941999563284},"min_number_of_hops":4},{"contribution_percentage":0.1428931397504208,"contribution_value":{"usd":0.009245186141852225},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch3","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.1428931397504208,"indirect_value":{"usd":0.009245186141852225},"min_number_of_hops":4},{"contribution_percentage":0.06395808977448295,"contribution_value":{"usd":0.004138088408409046},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch4","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.06395808977448295,"indirect_value":{"usd":0.004138088408409046},"min_number_of_hops":4},{"contribution_percentage":0.05274613176210563,"contribution_value":{"usd":0.0034126747250082345},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch5","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.05274613176210563,"indirect_value":{"usd":0.0034126747250082345},"min_number_of_hops":4},{"contribution_percentage":0.01476863233473315,"contribution_value":{"usd":0.0009555305120572348},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch6","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.01476863233473315,"indirect_value":{"usd":0.0009555305120572348},"min_number_of_hops":6},{"contribution_percentage":0.010327486789610252,"contribution_value":{"usd":0.0006681883952877833},"counterparty_percentage":0,"counterparty_value":{"usd":0},"entities":[{"name":"Exch7","category":"Exchange","actor_id":0,"is_primary_entity":true,"is_vasp":true}],"is_screened_address":false,"indirect_percentage":0.010327486789610252,"indirect_value":{"usd":0.0006681883952877833},"min_number_of_hops":5}]},"triggered_rules":[],"changes":{"risk_score_change":0},"screening_source":"sync","detected_behaviors":[]}""");
		result = await CVP2ApiResponse.ParseResponseAsync(message);
		result.Evaluate(0, riskConfig);
		detail = result.GetDetails();
		Assert.Equal("11|BRP|complete| 0.500(   NaN, 0.000, 0.000, 0.000)|||||ParseError Exception:Could not convert string to DateTime: crash. Path 'created_at', line 1, position 392.", detail);
	}

	[Fact]
	public async Task CoinVerifierProviderTestAsync()
	{
		CoinVerifierRiskConfig riskConfig = new(null, null);

		string apiURL = "https://api.provider.com/v1/address";
		string apiToken = "1234567890abcdef1234567890abcdef";
		string apiSecret = "fedcba0987654321fedcba0987654321";

		using CancellationTokenSource cts = new CancellationTokenSource(TimeSpan.FromMinutes(5));
		var ctsToken = cts.Token;

		using MockHttpClientResponse httpClient = new();

		httpClient.BaseAddress = new Uri(apiURL);
		await using CoinVerifierApiClient apiClient = new(CoinVerifierProvider.CVP2, apiToken, apiSecret, httpClient);

		httpClient.Content = """{"analysed_by":{"id":"10","type":"api_key"},"cluster_entities":[{"name":"Unknown","category":"Unknown","actor_id":0,"is_primary_entity":true,"is_vasp":null,"is_after_sanction_date":false}],"id":"11","screening_id":"12","subject":{"asset":"holistic","hash":"bc1234","type":"address","blockchain":"holistic"},"type":"wallet_exposure","customer":{"id":null,"reference":""},"created_at":"2024-05-29T00:00:00.000Z","updated_at":"2024-05-29T00:00:00.000Z","analysed_at":"2024-05-29T00:00:00.000Z","process_status":"complete","process_status_id":2,"workflow_status_id":1,"workflow_status":"active","error":null,"team_id":"13","asset_tier":"full","risk_score":10,"blockchain_info":{"cluster":{"inflow_value":{"usd":941.572289},"outflow_value":{"usd":915.247003}}},"risk_score_detail":{"destination":10,"source":10},"evaluation_detail":{"source":[{"rule_id":"14","rule_type":"exposure","risk_score":10,"matched_behaviors":[],"matched_elements":[{"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"contributions":[{"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"is_screened_address":false,"contribution_value":{"usd":941.572289},"indirect_percentage":0,"min_number_of_hops":1,"indirect_value":{"usd":0},"risk_triggers":{"category_id":"15","category":"Market"},"contribution_percentage":100,"entity":"Market1"}],"contribution_value":{"usd":941.572289},"indirect_percentage":0,"indirect_value":{"usd":0},"category":"Market","contribution_percentage":100}],"rule_name":"Illicit"}],"destination":[{"rule_id":"16","rule_type":"exposure","risk_score":10,"matched_behaviors":[],"matched_elements":[{"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"contributions":[{"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"is_screened_address":false,"contribution_value":{"usd":915.247003},"indirect_percentage":0,"min_number_of_hops":1,"indirect_value":{"usd":0},"risk_triggers":{"category_id":"17","category":"Wallet"},"contribution_percentage":100,"entity":"Wallet1"}],"contribution_value":{"usd":915.247003},"indirect_percentage":0,"indirect_value":{"usd":0},"category":"Wallet","contribution_percentage":100}],"rule_name":"Obfuscating"}]},"contributions":{"source":[{"contribution_percentage":100,"contribution_value":{"usd":941.572289},"counterparty_percentage":100,"counterparty_value":{"usd":941.572289},"entities":[{"name":"Market1","category":"Market","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}],"destination":[{"contribution_percentage":100,"contribution_value":{"usd":915.247003},"counterparty_percentage":100,"counterparty_value":{"usd":915.247003},"entities":[{"name":"Wallet1","category":"Wallet","actor_id":0,"is_primary_entity":true,"is_vasp":false}],"is_screened_address":false,"indirect_percentage":0,"indirect_value":{"usd":0},"min_number_of_hops":1}]},"triggered_rules":[],"changes":{},"screening_source":"sync","detected_behaviors":[]}""";
		var result = await apiClient.SendRequestAsync(CreatCoin(""), cts.Token);
		result.Evaluate(0, riskConfig);
		var detail = result.GetDetails();

		Assert.Equal("11|BR_|complete|10.000(10.000, 0.000,10.000,10.000)|Illicit(10.000)|Market|Obfuscating(10.000)|Wallet|", detail);
	}
}
